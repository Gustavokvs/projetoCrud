/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package view;

import controller.VendaController;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import javax.swing.JButton;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTable;
import javax.swing.JTextField;
import javax.swing.table.DefaultTableModel;
import model.Livro;
import model.Venda;

/**
 *
 * @author thain
 */
public class FrConVendas extends javax.swing.JDialog {


    /*
     * Creates new form FrConVendas
     */
    public FrConVendas(java.awt.Frame parent, boolean modal) {
        super(parent, modal);
        initComponents();

        this.setLocationRelativeTo(null);
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        btmExcluir = new javax.swing.JButton();
        btmVoltar = new javax.swing.JButton();
        BtmEditar = new javax.swing.JButton();
        jLabel1 = new javax.swing.JLabel();
        jScrollPane1 = new javax.swing.JScrollPane();
        tblVenda = new javax.swing.JTable();
        btnPesquisar = new javax.swing.JButton();
        jLabel4 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        jLabel5 = new javax.swing.JLabel();
        jLabel6 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);

        jPanel1.setBackground(new java.awt.Color(0, 0, 0));
        jPanel1.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        btmExcluir.setBackground(new java.awt.Color(255, 255, 153));
        btmExcluir.setFont(new java.awt.Font("Arial", 1, 14)); // NOI18N
        btmExcluir.setBorderPainted(false);
        btmExcluir.setContentAreaFilled(false);
        btmExcluir.setCursor(new java.awt.Cursor(java.awt.Cursor.HAND_CURSOR));
        btmExcluir.setFocusPainted(false);
        btmExcluir.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btmExcluirActionPerformed(evt);
            }
        });
        jPanel1.add(btmExcluir, new org.netbeans.lib.awtextra.AbsoluteConstraints(330, 520, 120, 40));

        btmVoltar.setBackground(new java.awt.Color(255, 255, 153));
        btmVoltar.setFont(new java.awt.Font("Arial", 1, 14)); // NOI18N
        btmVoltar.setBorderPainted(false);
        btmVoltar.setContentAreaFilled(false);
        btmVoltar.setCursor(new java.awt.Cursor(java.awt.Cursor.HAND_CURSOR));
        btmVoltar.setFocusPainted(false);
        btmVoltar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btmVoltarActionPerformed(evt);
            }
        });
        jPanel1.add(btmVoltar, new org.netbeans.lib.awtextra.AbsoluteConstraints(202, 520, 120, 40));

        BtmEditar.setBackground(new java.awt.Color(255, 255, 153));
        BtmEditar.setFont(new java.awt.Font("Arial", 1, 14)); // NOI18N
        BtmEditar.setBorderPainted(false);
        BtmEditar.setContentAreaFilled(false);
        BtmEditar.setCursor(new java.awt.Cursor(java.awt.Cursor.HAND_CURSOR));
        BtmEditar.setFocusPainted(false);
        BtmEditar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                BtmEditarActionPerformed(evt);
            }
        });
        jPanel1.add(BtmEditar, new org.netbeans.lib.awtextra.AbsoluteConstraints(460, 520, 120, 40));

        jLabel1.setFont(new java.awt.Font("Arial", 1, 18)); // NOI18N
        jLabel1.setForeground(new java.awt.Color(204, 204, 0));
        jLabel1.setText("Vendas");
        jPanel1.add(jLabel1, new org.netbeans.lib.awtextra.AbsoluteConstraints(320, 40, -1, -1));

        tblVenda.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null, null, null},
                {null, null, null, null, null, null},
                {null, null, null, null, null, null},
                {null, null, null, null, null, null}
            },
            new String [] {
                "ID", "Cliente", "Data", "Livro", "Quantidade", "Valor Total"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.String.class, java.lang.String.class, java.lang.String.class, java.lang.String.class, java.lang.String.class, java.lang.String.class
            };
            boolean[] canEdit = new boolean [] {
                false, false, false, false, false, false
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        jScrollPane1.setViewportView(tblVenda);

        jPanel1.add(jScrollPane1, new org.netbeans.lib.awtextra.AbsoluteConstraints(40, 130, 699, 350));

        btnPesquisar.setBackground(new java.awt.Color(255, 255, 153));
        btnPesquisar.setFont(new java.awt.Font("Arial", 1, 14)); // NOI18N
        btnPesquisar.setBorderPainted(false);
        btnPesquisar.setContentAreaFilled(false);
        btnPesquisar.setCursor(new java.awt.Cursor(java.awt.Cursor.HAND_CURSOR));
        btnPesquisar.setFocusPainted(false);
        btnPesquisar.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                btnPesquisarMouseClicked(evt);
            }
        });
        btnPesquisar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnPesquisarActionPerformed(evt);
            }
        });
        jPanel1.add(btnPesquisar, new org.netbeans.lib.awtextra.AbsoluteConstraints(610, 70, 120, 50));

        jLabel4.setIcon(new javax.swing.ImageIcon(getClass().getResource("/images/botao_editar.png"))); // NOI18N
        jPanel1.add(jLabel4, new org.netbeans.lib.awtextra.AbsoluteConstraints(460, 520, -1, 40));

        jLabel3.setIcon(new javax.swing.ImageIcon(getClass().getResource("/images/botao_excluir.png"))); // NOI18N
        jPanel1.add(jLabel3, new org.netbeans.lib.awtextra.AbsoluteConstraints(330, 520, 120, 40));

        jLabel5.setIcon(new javax.swing.ImageIcon(getClass().getResource("/images/botao_voltar.png"))); // NOI18N
        jPanel1.add(jLabel5, new org.netbeans.lib.awtextra.AbsoluteConstraints(200, 520, 120, 40));

        jLabel6.setIcon(new javax.swing.ImageIcon(getClass().getResource("/images/botao_pesquisar.png"))); // NOI18N
        jPanel1.add(jLabel6, new org.netbeans.lib.awtextra.AbsoluteConstraints(610, 70, 120, 50));

        jLabel2.setIcon(new javax.swing.ImageIcon(getClass().getResource("/images/fundo_logo.png"))); // NOI18N
        jPanel1.add(jLabel2, new org.netbeans.lib.awtextra.AbsoluteConstraints(420, 30, 360, 270));

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, 639, Short.MAX_VALUE)
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void btnPesquisarMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_btnPesquisarMouseClicked

    }//GEN-LAST:event_btnPesquisarMouseClicked

    private void btnPesquisarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnPesquisarActionPerformed
        pesquisar();

    }//GEN-LAST:event_btnPesquisarActionPerformed

    private void BtmEditarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_BtmEditarActionPerformed
        alterarVenda();

    }//GEN-LAST:event_BtmEditarActionPerformed

    private void btmExcluirActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btmExcluirActionPerformed
        excluirVenda();
    }//GEN-LAST:event_btmExcluirActionPerformed

    private void btmVoltarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btmVoltarActionPerformed
        dispose();        // TODO add your handling code here:
    }//GEN-LAST:event_btmVoltarActionPerformed

    private void alterarVenda() {
        // Verifica se há uma linha selecionada na tabela
        if (tblVenda.getSelectedRow() != -1) {
            // Se houver uma linha selecionada, pega o ID da venda (coluna 0)
            int linhaSelecionada = tblVenda.getSelectedRow();
            String textoCelula = tblVenda.getValueAt(linhaSelecionada, 0).toString();

            // Converte o texto da célula em inteiro
            int idVenda = Integer.parseInt(textoCelula);

            // Cria uma nova tela de alteração de venda passando o ID da venda
            FrAltVenda telaAltVenda = new FrAltVenda(new javax.swing.JFrame(), true, idVenda);  // Passando o idVenda corretamente

            // Exibe a tela de alteração
            telaAltVenda.setVisible(true);

            // Após fechar a tela de alteração, atualiza a tabela de vendas
            pesquisar();
        } else {
            // Exibe uma mensagem de erro caso nenhuma linha seja selecionada
            JOptionPane.showMessageDialog(rootPane, "Selecione uma venda para alterar.");
        }
    }

    private void excluirVenda() {
        int row = tblVenda.getSelectedRow();  // Pega a linha selecionada na tabela
        if (row != -1) {
            int idVenda = (int) tblVenda.getValueAt(row, 0);  // Obtém o ID da venda selecionada
            int confirm = JOptionPane.showConfirmDialog(this, "Tem certeza que deseja excluir esta venda?", "Confirmar Exclusão", JOptionPane.YES_NO_OPTION);
            if (confirm == JOptionPane.YES_OPTION) {
                // Chama o método da VendaController para excluir a venda
                VendaController.excluirVenda(idVenda);
                // Atualiza a tabela após a exclusão
                pesquisar();
                JOptionPane.showMessageDialog(this, "Venda excluída com sucesso.");
            }
        } else {
            JOptionPane.showMessageDialog(this, "Selecione uma venda para excluir.");
        }
    }

    public void pesquisar() {
        DefaultTableModel modelo = (DefaultTableModel) tblVenda.getModel();
        modelo.setRowCount(0); // Limpa a tabela antes de preencher

        VendaController controller = new VendaController();
        ArrayList<Venda> vendas = controller.listarTodos();
        System.out.println("Vendas no controlador: " + vendas.size());  // Aqui você vê quantas vendas estão sendo recuperadas

        for (Venda v : vendas) {
            StringBuilder livrosStr = new StringBuilder();
            StringBuilder qtdStr = new StringBuilder();
            double total = 0;

            for (Map.Entry<Livro, Integer> entry : v.getLivrosVendidos().entrySet()) {
                Livro livro = entry.getKey();
                int quantidade = entry.getValue();

                livrosStr.append(livro.getTitulo()).append(", ");
                qtdStr.append(quantidade).append(", ");

                total += livro.getPreco() * quantidade;
            }

            // Remover a última vírgula e espaço
            String livrosFormatado = livrosStr.length() > 0 ? livrosStr.substring(0, livrosStr.length() - 2) : "";
            String qtdFormatado = qtdStr.length() > 0 ? qtdStr.substring(0, qtdStr.length() - 2) : "";

            modelo.addRow(new Object[]{
                v.getId(),
                v.getClienteNome(),
                v.getDataVenda(),
                livrosFormatado,
                qtdFormatado,
                String.format("R$ %.2f", total)
            });
        }
    }

    public static void main(String[] args) {
        java.awt.EventQueue.invokeLater(new Runnable() {
            public void run() {
                FrConVendas dialog = new FrConVendas(new javax.swing.JFrame(), true);
                dialog.setVisible(true);
            }
        });
    }


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton BtmEditar;
    private javax.swing.JButton btmExcluir;
    private javax.swing.JButton btmVoltar;
    private javax.swing.JButton btnPesquisar;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JTable tblVenda;
    // End of variables declaration//GEN-END:variables
}
