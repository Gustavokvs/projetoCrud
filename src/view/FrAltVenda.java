/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package view;

import javax.swing.JList;
import javax.swing.JLabel;
import javax.swing.border.EmptyBorder;
import javax.swing.JPanel;
import controller.ClienteController;
import controller.LivroController;
import controller.VendaController;
import java.awt.Component;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import javax.swing.BoxLayout;
import javax.swing.JComboBox;
import javax.swing.JOptionPane;
import javax.swing.ListCellRenderer;
import model.Cliente;
import model.Livro;
import model.Venda;

/**
 *
 * @author gusta
 */
public class FrAltVenda extends javax.swing.JDialog {

    private int idVenda;
    private javax.swing.JPanel jPanelLivros = new javax.swing.JPanel();
    private Map<String, Cliente> mapaClientes = new HashMap<>();

    public FrAltVenda(java.awt.Frame parent, boolean modal, int idVenda) {
        super(parent, modal);
        this.idVenda = idVenda;
        initComponents();
        jPanelLivros.setLayout(new java.awt.GridLayout(0, 1, 10, 10));
        jPanel1.add(jPanelLivros, new org.netbeans.lib.awtextra.AbsoluteConstraints(240, 160, 700, 250));


        carregarVenda();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        lbData = new javax.swing.JLabel();
        lbCliente = new javax.swing.JLabel();
        edtData = new javax.swing.JTextField();
        lbLivro = new javax.swing.JLabel();
        btmSalvar = new javax.swing.JButton();
        btmCancelar = new javax.swing.JButton();
        comboCliente = new javax.swing.JComboBox<>();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);

        jPanel1.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        lbData.setText("Data");
        jPanel1.add(lbData, new org.netbeans.lib.awtextra.AbsoluteConstraints(220, 20, -1, -1));

        lbCliente.setText("Cliente");
        jPanel1.add(lbCliente, new org.netbeans.lib.awtextra.AbsoluteConstraints(50, 130, -1, -1));
        jPanel1.add(edtData, new org.netbeans.lib.awtextra.AbsoluteConstraints(190, 50, 92, -1));

        lbLivro.setText("Livro");
        jPanel1.add(lbLivro, new org.netbeans.lib.awtextra.AbsoluteConstraints(240, 130, -1, -1));

        btmSalvar.setText("Salvar");
        btmSalvar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btmSalvarActionPerformed(evt);
            }
        });
        jPanel1.add(btmSalvar, new org.netbeans.lib.awtextra.AbsoluteConstraints(310, 480, -1, -1));

        btmCancelar.setText("Cancelar");
        btmCancelar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btmCancelarActionPerformed(evt);
            }
        });
        jPanel1.add(btmCancelar, new org.netbeans.lib.awtextra.AbsoluteConstraints(100, 480, -1, -1));

        comboCliente.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "Item 1", "Item 2", "Item 3", "Item 4" }));
        jPanel1.add(comboCliente, new org.netbeans.lib.awtextra.AbsoluteConstraints(40, 160, -1, -1));

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, 798, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(0, 0, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, 580, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(0, 0, Short.MAX_VALUE))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void btmSalvarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btmSalvarActionPerformed
        salvarVenda();

    }//GEN-LAST:event_btmSalvarActionPerformed

    private void btmCancelarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btmCancelarActionPerformed
        dispose();        // TODO add your handling code here:
    }//GEN-LAST:event_btmCancelarActionPerformed

    private void preencherComboBoxCliente() {
        ClienteController clienteController = new ClienteController();
        List<Cliente> listaClientes = clienteController.listarTodos();

        comboCliente.removeAllItems();
        mapaClientes.clear();

        for (Cliente cliente : listaClientes) {
            String nome = cliente.getNome();
            comboCliente.addItem(nome);
            mapaClientes.put(nome, cliente);
        }
    }

    private void carregarVenda() {
        VendaController vendaController = new VendaController();
        Venda venda = vendaController.getVendaPorId(idVenda);

        preencherComboBoxCliente();

        Cliente cliente = new ClienteController().buscarPorId(venda.getIdCliente());
        comboCliente.setSelectedItem(cliente.getNome());
        edtData.setText(venda.getDataVenda().format(DateTimeFormatter.ofPattern("dd/MM/yyyy")));

        for (Map.Entry<Livro, Integer> entry : venda.getLivrosVendidos().entrySet()) {
            adicionarLivroEQuantidade(entry.getKey(), entry.getValue());
        }
    }

private void adicionarLivroEQuantidade(Livro livro, Integer quantidade) {
    // Painel para um único par Livro + Quantidade
    JPanel painelLivroQuant = new JPanel();
    painelLivroQuant.setBorder(new EmptyBorder(2, 0, 2, 0)); // top, left, bottom, right
    painelLivroQuant.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 10, 2)); // Reduzido vgap

    // Cria o JComboBox de livros com todos os livros disponíveis
    JComboBox<Livro> comboLivros = new JComboBox<>();
    LivroController livroController = new LivroController();
    List<Livro> listaLivros = livroController.listarTodos();
    for (Livro l : listaLivros) {
        comboLivros.addItem(l);
    }
    for (int i = 0; i < comboLivros.getItemCount(); i++) {
        Livro item = comboLivros.getItemAt(i);
        if (item != null && item.getId() == livro.getId()) {
            comboLivros.setSelectedIndex(i);
            break;
        }
    }

    // Cria o JComboBox de quantidade
    JComboBox<Integer> comboQuant = new JComboBox<>();
    for (int i = 1; i <= 10; i++) {
        comboQuant.addItem(i);
    }
    comboQuant.setSelectedItem(quantidade);

    // Tamanho dos JComboBox
    comboLivros.setPreferredSize(new java.awt.Dimension(180, comboLivros.getPreferredSize().height));
    comboQuant.setPreferredSize(new java.awt.Dimension(80, comboQuant.getPreferredSize().height));

    painelLivroQuant.add(comboLivros);
    painelLivroQuant.add(comboQuant);

    // Certifica-se que jPanelLivros use um alinhamento à esquerda e layout vertical
    jPanelLivros.setLayout(new BoxLayout(jPanelLivros, BoxLayout.Y_AXIS));
    jPanelLivros.setAlignmentX(RIGHT_ALIGNMENT);

    painelLivroQuant.setAlignmentX(RIGHT_ALIGNMENT); // Alinha o painel individual à esquerda

    jPanelLivros.add(painelLivroQuant);
    jPanelLivros.revalidate();
    jPanelLivros.repaint();
}

    private void salvarVenda() {
        try {
            String nomeSelecionado = comboCliente.getSelectedItem().toString();
            Cliente cliente = mapaClientes.get(nomeSelecionado); // CERTO

            if (cliente == null) {
                JOptionPane.showMessageDialog(this, "Selecione um cliente.", "Erro", JOptionPane.ERROR_MESSAGE);
                return;
            }

            String dataStr = edtData.getText().trim();
            LocalDate dataVenda = LocalDate.parse(dataStr, DateTimeFormatter.ofPattern("dd/MM/yyyy"));

            Map<Livro, Integer> livrosVendidos = new HashMap<>();
            for (Component comp : jPanelLivros.getComponents()) {
                if (comp instanceof JPanel) {
                    JPanel painel = (JPanel) comp;
                    JComboBox<Livro> comboLivros = (JComboBox<Livro>) painel.getComponent(0);
                    JComboBox<Integer> comboQuant = (JComboBox<Integer>) painel.getComponent(1);

                    Livro livro = (Livro) comboLivros.getSelectedItem();
                    Integer quantidade = (Integer) comboQuant.getSelectedItem();

                    if (livro != null && quantidade != null) {
                        livrosVendidos.put(livro, quantidade);
                    }
                }
            }

            if (livrosVendidos.isEmpty()) {
                JOptionPane.showMessageDialog(this, "Adicione pelo menos um livro à venda.", "Erro", JOptionPane.ERROR_MESSAGE);
                return;
            }

            Venda venda = new Venda(idVenda, cliente, livrosVendidos, dataVenda);
            VendaController vendaController = new VendaController();
            vendaController.alterarVenda(venda);

            JOptionPane.showMessageDialog(this, "Venda atualizada com sucesso.");
            dispose();

        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, "Erro ao salvar a venda: " + e.getMessage(), "Erro", JOptionPane.ERROR_MESSAGE);
            e.printStackTrace();
        }
    }

    private Cliente buscarClientePorId(int id) {
        // Lógica para buscar o cliente pelo ID, pode ser feito via controlador ou banco de dados
        // Exemplo de implementação fictícia:
        ClienteController clienteController = new ClienteController();
        return clienteController.buscarPorId(id);
    }

    // Método fictício para buscar livro por título
    private Livro buscarLivroPorTitulo(String titulo) {
        // Lógica de busca pelo título (pode ser feito via controlador ou diretamente no banco)
        // Este é apenas um exemplo
        return new Livro();  // Retorna um novo livro, a lógica de busca precisa ser implementada
    }

    public static void main(String args[]) {
        java.awt.EventQueue.invokeLater(new Runnable() {
            public void run() {
                FrAltVenda dialog = new FrAltVenda(new javax.swing.JFrame(), true, 1);
                dialog.addWindowListener(new java.awt.event.WindowAdapter() {
                    @Override
                    public void windowClosing(java.awt.event.WindowEvent e) {
                        System.exit(0);
                    }
                });
                dialog.setVisible(true);
            }
        });
    }
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btmCancelar;
    private javax.swing.JButton btmSalvar;
    private javax.swing.JComboBox<String> comboCliente;
    private javax.swing.JTextField edtData;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JLabel lbCliente;
    private javax.swing.JLabel lbData;
    private javax.swing.JLabel lbLivro;
    // End of variables declaration//GEN-END:variables
}
